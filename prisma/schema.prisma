generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  MODERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

model User {
  id                     Int                  @id @default(autoincrement())
  fullName               String?
  username               String               @unique
  email                  String               @unique
  passwordHash           String
  age                    Int?
  isPrivate              Boolean              @default(false)
  isOnline               Boolean              @default(false)
  lastSeen               DateTime             @default(now())
  role                   Role                 @default(USER)
  status                 UserStatus           @default(ACTIVE)
  profilePic             String?
  chats1                 Chat[]               @relation("ChatUser1")
  chats2                 Chat[]               @relation("ChatUser2")
  messages               Message[]
  flaggedMsgs            FlaggedMessage[]     @relation("FlaggedByUser")
  moderatedFlags         FlaggedMessage[]     @relation("FlaggedByModerator")
  moderationLogs         ModerationLog[]      @relation("ModeratorLogs")
  auditLogs              AuditLog[]
  notifications          Notification[]
  reportsReported        Report[]             @relation("ReportReporter")
  resetTokens            PasswordResetToken[]
  friendshipsInitiated   Friendship[]         @relation("FriendshipUserA")
  friendshipsReceived    Friendship[]         @relation("FriendshipUserB")
  friendRequestsSent     FriendRequest[]      @relation("FriendRequestsSent")
  friendRequestsReceived FriendRequest[]      @relation("FriendRequestsReceived")
  messageReadReceipts    MessageReadReceipt[]
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Chat {
  id            Int            @id @default(autoincrement())
  user1         User           @relation("ChatUser1", fields: [user1Id], references: [id])
  user1Id       Int
  user2         User           @relation("ChatUser2", fields: [user2Id], references: [id])
  user2Id       Int
  type          String         @default("direct")
  name          String?
  title         String?
  messages      Message[]
  notifications Notification[]
  reports       Report[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Message {
  id               Int             @id @default(autoincrement())
  chat             Chat            @relation(fields: [chatId], references: [id])
  chatId           Int
  user             User            @relation(fields: [userId], references: [id])
  userId           Int
  messageText      String
  toxicityScore    Float?
  toxicityCategory String?
  emotion          String?
  isFlagged        Boolean         @default(false)
  flaggedMessage   FlaggedMessage?
  moderationLogs   ModerationLog[]
  notifications    Notification[]
  readReceipts     MessageReadReceipt[]
  createdAt        DateTime        @default(now())
}

model FlaggedMessage {
  id               Int      @id @default(autoincrement())
  message          Message  @relation(fields: [messageId], references: [id])
  messageId        Int      @unique // ✅ Make it one-to-one
  user             User     @relation("FlaggedByUser", fields: [userId], references: [id])
  userId           Int
  flaggedBy        User?    @relation("FlaggedByModerator", fields: [flaggedById], references: [id])
  flaggedById      Int?
  toxicityCategory String?
  confidence       Float?
  createdAt        DateTime @default(now())
}

model ModerationLog {
  id          Int      @id @default(autoincrement())
  moderator   User     @relation("ModeratorLogs", fields: [moderatorId], references: [id])
  moderatorId Int
  message     Message  @relation(fields: [messageId], references: [id])
  messageId   Int
  action      String
  category    String?
  decision    String?
  confidence  Float?
  reason      String?
  createdAt   DateTime @default(now())
}

enum ModelStatus {
  ACTIVE
  DISABLED
}

model AIModel {
  id          Int         @id @default(autoincrement())
  name        String
  endpoint    String
  status      ModelStatus @default(ACTIVE)
  threshold   Float       @default(0.85)
  lastUpdated DateTime    @default(now())
}

enum ReportStatus {
  PENDING
  REVIEWED
  CLOSED
}

model Report {
  id         Int          @id @default(autoincrement())
  reporter   User         @relation("ReportReporter", fields: [reporterId], references: [id])
  reporterId Int
  chat       Chat         @relation(fields: [chatId], references: [id])
  chatId     Int
  message    String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
}

enum NotificationType {
  MESSAGE // new message notification
  CHAT // new chat created
  FLAGGED // flagged message alert
  MODERATION // moderation action result
  SYSTEM // password reset, login alert, etc.
  FRIEND_REQUEST
  FRIEND_ACTIVITY
}

model Notification {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int

  type    NotificationType
  title   String?
  content String?

  // Optional relations — depends on notification type
  chat   Chat? @relation(fields: [chatId], references: [id])
  chatId Int?

  message   Message? @relation(fields: [messageId], references: [id])
  messageId Int?

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

model FriendRequest {
  id          Int                 @id @default(autoincrement())
  requester   User                @relation("FriendRequestsSent", fields: [requesterId], references: [id])
  requesterId Int
  receiver    User                @relation("FriendRequestsReceived", fields: [receiverId], references: [id])
  receiverId  Int
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([requesterId, receiverId])
}

model Friendship {
  id        Int      @id @default(autoincrement())
  userA     User     @relation("FriendshipUserA", fields: [userAId], references: [id])
  userAId   Int
  userB     User     @relation("FriendshipUserB", fields: [userBId], references: [id])
  userBId   Int
  createdAt DateTime @default(now())

  @@unique([userAId, userBId])
}

model MessageReadReceipt {
  id        Int      @id @default(autoincrement())
  message   Message  @relation(fields: [messageId], references: [id])
  messageId Int
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
}
